import streamlit as st
from rag_pipeline import process_documents, generate_summary

# --- STREAMLIT PAGE CONFIG ---
st.set_page_config(
    page_title="TCS AI Fridays Legal Document Summarizer",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- SESSION STATE INITIALIZATION ---
if 'vectorstore' not in st.session_state:
    st.session_state['vectorstore'] = None
if 'summary' not in st.session_state:
    st.session_state['summary'] = None


# --- MAIN APPLICATION ---
st.title("⚖️ Automated Legal Document Summarization")
st.markdown("---")

# 1. File Upload and Processing
st.sidebar.header("Upload Contracts")
uploaded_files = st.sidebar.file_uploader(
    "Upload Media Contracts (PDF or TXT)",
    type=["pdf", "txt"],
    accept_multiple_files=True
)

if uploaded_files:
    if st.sidebar.button("Process Documents & Create Knowledge Base"):
        with st.spinner("Processing documents... Splitting text and creating vector embeddings (Chroma)..."):
            # Call the function from rag_pipeline.py
            vectorstore = process_documents(uploaded_files)
            
            if vectorstore:
                st.session_state['vectorstore'] = vectorstore
                st.sidebar.success(f"✅ Processed {len(uploaded_files)} file(s). RAG knowledge base ready!")
            else:
                st.sidebar.error("❌ Failed to process documents.")
else:
    st.session_state['vectorstore'] = None


# 2. Summary Generation
st.header("Summary Generation")

if st.session_state['vectorstore'] is None:
    st.warning("Please upload and process legal documents in the sidebar first.")
else:
    if st.button("Generate Structured Summary"):
        with st.spinner("Analyzing document and generating summary with RAG..."):
            # Call the function from rag_pipeline.py
            summary_text = generate_summary(st.session_state['vectorstore'])
            
            st.session_state['summary'] = summary_text
            st.success("Summary Generated!")


# 3. Output Display
if st.session_state['summary']:
    st.markdown("---")
    st.subheader("Final Structured Output")
    
    # Use st.markdown to render the structured text including the Markdown formatting from the LLM
    st.markdown(st.session_state['summary'])
    
    # Optional: Allow user to download the summary
    st.download_button(
        label="Download Summary (TXT)",
        data=st.session_state['summary'],
        file_name="legal_summary.txt",
        mime="text/plain"
    )

